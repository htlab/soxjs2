"use strict";

var _device = require("./device");

var _device2 = _interopRequireDefault(_device);

var _device_meta = require("./device_meta");

var _device_meta2 = _interopRequireDefault(_device_meta);

var _meta_transducer = require("./meta_transducer");

var _meta_transducer2 = _interopRequireDefault(_meta_transducer);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var _xmlDeclarePatStr = "^<\\?xml[^>]+?>";
var _xmlDeclarePat = new RegExp(_xmlDeclarePatStr);

var XmlUtil = {

  removeXmlDeclaration: function removeXmlDeclaration(xmlString) {
    return xmlString.replace(_xmlDeclarePat, "");
  },

  dumpDom: function dumpDom(dom, indent) {
    if (indent === undefined) {
      indent = 0;
    }
    var tagName = dom._localName;
    var children = dom._childNodesList;
    var attrs = dom._attributes;

    var sp = "";
    for (var i = 0; i < indent; i++) {
      sp = sp + "  ";
    }

    var log = function log(msg) {
      console.log(sp + msg);
    };

    log("---tag: " + tagName);
    // log("---attributes:");
    // for (let aName of Object.keys(attrs)) {
    //   let av = attrs[aName]._valueForAttrModified;
    //   log("  - " + aName + ": " + av);
    // }
    if (children && 0 < children.length) {
      log("---children:");
      for (var i = 0; i < children.length; i++) {
        var c = children[i];
        XmlUtil.dumpDom(c, indent + 1);
      }
    }
  },

  convRecentItem: function convRecentItem(soxConnection, iq) {
    XmlUtil.dumpDom(iq);
    var fromService = iq._attributes['from']._valueForAttrModified;
    var fromDomain = fromService.substring(7);

    var pubsubTag = iq._childNodesList[0];
    var itemsTag = pubsubTag._childNodesList[0];
    var itemTag = itemsTag._childNodesList[0];
    var deviceTag = itemTag._childNodesList[0];
    var transducerTags = deviceTag._childNodesList;

    var getAttr = function getAttr(attrs, name) {
      var v = attrs[name];
      return v ? v._valueForAttrModified : v;
    };

    // device: name, id, type, serialNumber
    var deviceTagAttr = deviceTag._attributes;
    var deviceName = getAttr(deviceTagAttr, 'name');
    var deviceId = getAttr(deviceTagAttr, 'id');
    var deviceType = getAttr(deviceTagAttr, 'type');
    var deviceSerialNumber = getAttr(deviceTagAttr, 'serialNumber');

    // transducer: name, id, canActuate, hasOwnNode, units,
    //             unitScalar, minValue, maxValue, resolution
    var device = new _device2.default(soxConnection, deviceName, fromDomain);
    var transducers = [];

    for (var i = 0; i < transducerTags.length; i++) {
      var tdrTag = transducerTags[i];
      if (tdrTag._localName !== 'transducer') {
        continue;
      }
      var tdrAttrs = tdrTag._attributes;

      transducers.push(new _meta_transducer2.default(device, getAttr(tdrAttrs, 'name'), getAttr(tdrAttrs, 'id'), getAttr(tdrAttrs, 'canActuate'), getAttr(tdrAttrs, 'hasOwnNode'), getAttr(tdrAttrs, 'units'), getAttr(tdrAttrs, 'unitScalar'), getAttr(tdrAttrs, 'minValue'), getAttr(tdrAttrs, 'maxValue'), getAttr(tdrAttrs, 'resolution')));
    }

    var meta = new _device_meta2.default(device, deviceId, deviceType, deviceSerialNumber, transducers);
    return meta;
  },

  convSubscriptions: function convSubscriptions(iq) {
    var pubsubTag = iq._childNodesList[0];
    var subscriptionsTag = pubsubTag._childNodesList[0];
    var subscriptionTags = subscriptionsTag._childNodesList;

    var ret = {};
    for (var i = 0; i < subscriptionTags.length; i++) {
      var subscriptionTag = subscriptionTags[i];

      var attrs = subscriptionTag._attributes;

      var jid = attrs.jid._valueForAttrModified;
      if (ret[jid] === undefined) {
        ret[jid] = {};
      }

      var nodeName = attrs.node._valueForAttrModified;
      var subidAttr = attrs.subid;
      if (subidAttr !== undefined) {
        var subid = subidAttr._valueForAttrModified;
        if (ret[jid][nodeName] === undefined) {
          ret[jid][nodeName] = [];
        }
        ret[jid][nodeName].push(subid);
      } else {
        ret[jid][nodeName] = [];
      }
    }

    return ret;
  }

};

module.exports = XmlUtil;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy94bWxfdXRpbC5qcyJdLCJuYW1lcyI6WyJfeG1sRGVjbGFyZVBhdFN0ciIsIl94bWxEZWNsYXJlUGF0IiwiUmVnRXhwIiwiWG1sVXRpbCIsInJlbW92ZVhtbERlY2xhcmF0aW9uIiwieG1sU3RyaW5nIiwicmVwbGFjZSIsImR1bXBEb20iLCJkb20iLCJpbmRlbnQiLCJ1bmRlZmluZWQiLCJ0YWdOYW1lIiwiX2xvY2FsTmFtZSIsImNoaWxkcmVuIiwiX2NoaWxkTm9kZXNMaXN0IiwiYXR0cnMiLCJfYXR0cmlidXRlcyIsInNwIiwiaSIsImxvZyIsIm1zZyIsImNvbnNvbGUiLCJsZW5ndGgiLCJjIiwiY29udlJlY2VudEl0ZW0iLCJzb3hDb25uZWN0aW9uIiwiaXEiLCJmcm9tU2VydmljZSIsIl92YWx1ZUZvckF0dHJNb2RpZmllZCIsImZyb21Eb21haW4iLCJzdWJzdHJpbmciLCJwdWJzdWJUYWciLCJpdGVtc1RhZyIsIml0ZW1UYWciLCJkZXZpY2VUYWciLCJ0cmFuc2R1Y2VyVGFncyIsImdldEF0dHIiLCJuYW1lIiwidiIsImRldmljZVRhZ0F0dHIiLCJkZXZpY2VOYW1lIiwiZGV2aWNlSWQiLCJkZXZpY2VUeXBlIiwiZGV2aWNlU2VyaWFsTnVtYmVyIiwiZGV2aWNlIiwidHJhbnNkdWNlcnMiLCJ0ZHJUYWciLCJ0ZHJBdHRycyIsInB1c2giLCJtZXRhIiwiY29udlN1YnNjcmlwdGlvbnMiLCJzdWJzY3JpcHRpb25zVGFnIiwic3Vic2NyaXB0aW9uVGFncyIsInJldCIsInN1YnNjcmlwdGlvblRhZyIsImppZCIsIm5vZGVOYW1lIiwibm9kZSIsInN1YmlkQXR0ciIsInN1YmlkIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLElBQUlBLG9CQUFvQixpQkFBeEI7QUFDQSxJQUFJQyxpQkFBaUIsSUFBSUMsTUFBSixDQUFXRixpQkFBWCxDQUFyQjs7QUFHQSxJQUFJRyxVQUFV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QyxTQUFqQixFQUE0QjtBQUMxQjJDLFlBQUlFLEdBQUosSUFBVyxFQUFYO0FBQ0Q7O0FBRUQsVUFBSUMsV0FBV3pDLE1BQU0wQyxJQUFOLENBQVc3QixxQkFBMUI7QUFDQSxVQUFJOEIsWUFBWTNDLE1BQU00QyxLQUF0QjtBQUNBLFVBQUlELGNBQWNoRCxTQUFsQixFQUE2QjtBQUMzQixZQUFJaUQsUUFBUUQsVUFBVTlCLHFCQUF0QjtBQUNBLFlBQUl5QixJQUFJRSxHQUFKLEVBQVNDLFFBQVQsTUFBdUI5QyxTQUEzQixFQUFzQztBQUNwQzJDLGNBQUlFLEdBQUosRUFBU0MsUUFBVCxJQUFxQixFQUFyQjtBQUNEO0FBQ0RILFlBQUlFLEdBQUosRUFBU0MsUUFBVCxFQUFtQlIsSUFBbkIsQ0FBd0JXLEtBQXhCO0FBQ0QsT0FORCxNQU1PO0FBQ0xOLFlBQUlFLEdBQUosRUFBU0MsUUFBVCxJQUFxQixFQUFyQjtBQUNEO0FBQ0Y7O0FBRUQsV0FBT0gsR0FBUDtBQUNEOztBQTFIVyxDQUFkOztBQThIQU8sT0FBT0MsT0FBUCxHQUFpQjFELE9BQWpCIiwiZmlsZSI6InhtbF91dGlsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5cbmltcG9ydCBEZXZpY2UgZnJvbSBcIi4vZGV2aWNlXCI7XG5pbXBvcnQgRGV2aWNlTWV0YSBmcm9tIFwiLi9kZXZpY2VfbWV0YVwiO1xuaW1wb3J0IE1ldGFUcmFuc2R1Y2VyIGZyb20gXCIuL21ldGFfdHJhbnNkdWNlclwiO1xuXG52YXIgX3htbERlY2xhcmVQYXRTdHIgPSBcIl48XFxcXD94bWxbXj5dKz8+XCI7XG52YXIgX3htbERlY2xhcmVQYXQgPSBuZXcgUmVnRXhwKF94bWxEZWNsYXJlUGF0U3RyKTtcblxuXG5sZXQgWG1sVXRpbCA9IHtcblxuICByZW1vdmVYbWxEZWNsYXJhdGlvbjogKHhtbFN0cmluZykgPT4ge1xuICAgIHJldHVybiB4bWxTdHJpbmcucmVwbGFjZShfeG1sRGVjbGFyZVBhdCwgXCJcIik7XG4gIH0sXG5cbiAgZHVtcERvbTogKGRvbSwgaW5kZW50KSA9PiB7XG4gICAgaWYgKGluZGVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBpbmRlbnQgPSAwO1xuICAgIH1cbiAgICBsZXQgdGFnTmFtZSA9IGRvbS5fbG9jYWxOYW1lO1xuICAgIGxldCBjaGlsZHJlbiA9IGRvbS5fY2hpbGROb2Rlc0xpc3Q7XG4gICAgbGV0IGF0dHJzID0gZG9tLl9hdHRyaWJ1dGVzO1xuXG4gICAgdmFyIHNwID0gXCJcIjtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGVudDsgaSsrKSB7XG4gICAgICBzcCA9IHNwICsgXCIgIFwiO1xuICAgIH1cblxuICAgIGxldCBsb2cgPSAobXNnKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZyhzcCArIG1zZyk7XG4gICAgfTtcblxuICAgIGxvZyhcIi0tLXRhZzogXCIgKyB0YWdOYW1lKTtcbiAgICAvLyBsb2coXCItLS1hdHRyaWJ1dGVzOlwiKTtcbiAgICAvLyBmb3IgKGxldCBhTmFtZSBvZiBPYmplY3Qua2V5cyhhdHRycykpIHtcbiAgICAvLyAgIGxldCBhdiA9IGF0dHJzW2FOYW1lXS5fdmFsdWVGb3JBdHRyTW9kaWZpZWQ7XG4gICAgLy8gICBsb2coXCIgIC0gXCIgKyBhTmFtZSArIFwiOiBcIiArIGF2KTtcbiAgICAvLyB9XG4gICAgaWYgKGNoaWxkcmVuICYmIDAgPCBjaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgIGxvZyhcIi0tLWNoaWxkcmVuOlwiKTtcbiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2hpbGRyZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgbGV0IGMgPSBjaGlsZHJlbltpXTtcbiAgICAgICAgWG1sVXRpbC5kdW1wRG9tKGMsIGluZGVudCArIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBjb252UmVjZW50SXRlbTogKHNveENvbm5lY3Rpb24sIGlxKSA9PiB7XG4gICAgWG1sVXRpbC5kdW1wRG9tKGlxKTtcbiAgICBsZXQgZnJvbVNlcnZpY2UgPSBpcS5fYXR0cmlidXRlc1snZnJvbSddLl92YWx1ZUZvckF0dHJNb2RpZmllZDtcbiAgICBsZXQgZnJvbURvbWFpbiA9IGZyb21TZXJ2aWNlLnN1YnN0cmluZyg3KTtcblxuICAgIGxldCBwdWJzdWJUYWcgPSBpcS5fY2hpbGROb2Rlc0xpc3RbMF07XG4gICAgbGV0IGl0ZW1zVGFnID0gcHVic3ViVGFnLl9jaGlsZE5vZGVzTGlzdFswXTtcbiAgICBsZXQgaXRlbVRhZyA9IGl0ZW1zVGFnLl9jaGlsZE5vZGVzTGlzdFswXTtcbiAgICBsZXQgZGV2aWNlVGFnID0gaXRlbVRhZy5fY2hpbGROb2Rlc0xpc3RbMF07XG4gICAgbGV0IHRyYW5zZHVjZXJUYWdzID0gZGV2aWNlVGFnLl9jaGlsZE5vZGVzTGlzdDtcblxuICAgIGxldCBnZXRBdHRyID0gKGF0dHJzLCBuYW1lKSA9PiB7XG4gICAgICBsZXQgdiA9IGF0dHJzW25hbWVdO1xuICAgICAgcmV0dXJuICh2KSA/IHYuX3ZhbHVlRm9yQXR0ck1vZGlmaWVkIDogdjtcbiAgICB9O1xuXG4gICAgLy8gZGV2aWNlOiBuYW1lLCBpZCwgdHlwZSwgc2VyaWFsTnVtYmVyXG4gICAgbGV0IGRldmljZVRhZ0F0dHIgPSBkZXZpY2VUYWcuX2F0dHJpYnV0ZXM7XG4gICAgbGV0IGRldmljZU5hbWUgPSBnZXRBdHRyKGRldmljZVRhZ0F0dHIsICduYW1lJyk7XG4gICAgbGV0IGRldmljZUlkID0gZ2V0QXR0cihkZXZpY2VUYWdBdHRyLCAnaWQnKTtcbiAgICBsZXQgZGV2aWNlVHlwZSA9IGdldEF0dHIoZGV2aWNlVGFnQXR0ciwgJ3R5cGUnKTtcbiAgICBsZXQgZGV2aWNlU2VyaWFsTnVtYmVyID0gZ2V0QXR0cihkZXZpY2VUYWdBdHRyLCAnc2VyaWFsTnVtYmVyJyk7XG5cbiAgICAvLyB0cmFuc2R1Y2VyOiBuYW1lLCBpZCwgY2FuQWN0dWF0ZSwgaGFzT3duTm9kZSwgdW5pdHMsXG4gICAgLy8gICAgICAgICAgICAgdW5pdFNjYWxhciwgbWluVmFsdWUsIG1heFZhbHVlLCByZXNvbHV0aW9uXG4gICAgbGV0IGRldmljZSA9IG5ldyBEZXZpY2Uoc294Q29ubmVjdGlvbiwgZGV2aWNlTmFtZSwgZnJvbURvbWFpbik7XG4gICAgbGV0IHRyYW5zZHVjZXJzID0gW107XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRyYW5zZHVjZXJUYWdzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgdGRyVGFnID0gdHJhbnNkdWNlclRhZ3NbaV07XG4gICAgICBpZiAodGRyVGFnLl9sb2NhbE5hbWUgIT09ICd0cmFuc2R1Y2VyJykge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIGxldCB0ZHJBdHRycyA9IHRkclRhZy5fYXR0cmlidXRlcztcblxuICAgICAgdHJhbnNkdWNlcnMucHVzaChuZXcgTWV0YVRyYW5zZHVjZXIoXG4gICAgICAgIGRldmljZSxcbiAgICAgICAgZ2V0QXR0cih0ZHJBdHRycywgJ25hbWUnKSxcbiAgICAgICAgZ2V0QXR0cih0ZHJBdHRycywgJ2lkJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICdjYW5BY3R1YXRlJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICdoYXNPd25Ob2RlJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICd1bml0cycpLFxuICAgICAgICBnZXRBdHRyKHRkckF0dHJzLCAndW5pdFNjYWxhcicpLFxuICAgICAgICBnZXRBdHRyKHRkckF0dHJzLCAnbWluVmFsdWUnKSxcbiAgICAgICAgZ2V0QXR0cih0ZHJBdHRycywgJ21heFZhbHVlJyksXG4gICAgICAgIGdldEF0dHIodGRyQXR0cnMsICdyZXNvbHV0aW9uJylcbiAgICAgICkpO1xuICAgIH1cblxuICAgIGxldCBtZXRhID0gbmV3IERldmljZU1ldGEoXG4gICAgICBkZXZpY2UsIGRldmljZUlkLCBkZXZpY2VUeXBlLCBkZXZpY2VTZXJpYWxOdW1iZXIsIHRyYW5zZHVjZXJzKTtcbiAgICByZXR1cm4gbWV0YTtcbiAgfSxcblxuICBjb252U3Vic2NyaXB0aW9uczogKGlxKSA9PiB7XG4gICAgbGV0IHB1YnN1YlRhZyA9IGlxLl9jaGlsZE5vZGVzTGlzdFswXTtcbiAgICBsZXQgc3Vic2NyaXB0aW9uc1RhZyA9IHB1YnN1YlRhZy5fY2hpbGROb2Rlc0xpc3RbMF07XG4gICAgbGV0IHN1YnNjcmlwdGlvblRhZ3MgPSBzdWJzY3JpcHRpb25zVGFnLl9jaGlsZE5vZGVzTGlzdDtcblxuICAgIGxldCByZXQgPSB7fTtcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN1YnNjcmlwdGlvblRhZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgIGxldCBzdWJzY3JpcHRpb25UYWcgPSBzdWJzY3JpcHRpb25UYWdzW2ldO1xuXG4gICAgICBsZXQgYXR0cnMgPSBzdWJzY3JpcHRpb25UYWcuX2F0dHJpYnV0ZXM7XG5cbiAgICAgIGxldCBqaWQgPSBhdHRycy5qaWQuX3ZhbHVlRm9yQXR0ck1vZGlmaWVkO1xuICAgICAgaWYgKHJldFtqaWRdID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0W2ppZF0gPSB7fTtcbiAgICAgIH1cblxuICAgICAgbGV0IG5vZGVOYW1lID0gYXR0cnMubm9kZS5fdmFsdWVGb3JBdHRyTW9kaWZpZWQ7XG4gICAgICBsZXQgc3ViaWRBdHRyID0gYXR0cnMuc3ViaWQ7XG4gICAgICBpZiAoc3ViaWRBdHRyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgbGV0IHN1YmlkID0gc3ViaWRBdHRyLl92YWx1ZUZvckF0dHJNb2RpZmllZDtcbiAgICAgICAgaWYgKHJldFtqaWRdW25vZGVOYW1lXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgcmV0W2ppZF1bbm9kZU5hbWVdID0gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0W2ppZF1bbm9kZU5hbWVdLnB1c2goc3ViaWQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0W2ppZF1bbm9kZU5hbWVdID0gW107XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJldDtcbiAgfVxuXG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFhtbFV0aWw7XG4iXX0=